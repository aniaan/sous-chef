name: Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-and-upload:
    name: Build and Upload Assets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Build Binaries
        run: |
          # Extract version from tag (removes 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Building version $VERSION"

          # Run the make release command, overriding the VERSION variable
          make release VERSION=$VERSION

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            sous-chef-darwin-amd64 \
            sous-chef-darwin-arm64 \
            sous-chef-linux-amd64
